{"version":3,"file":"lethal.DYAN9FjL.js","sources":["../../src/utils/lethal.ts"],"sourcesContent":["//////////////////////////////\n///          Init          ///\n//////////////////////////////\nimport { BareMuxConnection } from \"@mercuryworkshop/bare-mux\";\n\n//////////////////////////////\n///         Options        ///\n//////////////////////////////\nconst connection = new BareMuxConnection(\"/bareworker.js\");\n\nlet wispURL: string;\nlet transportURL: string;\n\nexport let tabCounter: number = 0;\nexport let currentTab: number = 0;\nexport let framesElement: HTMLElement;\nexport let currentFrame: HTMLIFrameElement;\nexport const addressInput: HTMLInputElement = document.getElementById(\n\t\"address\",\n) as HTMLInputElement;\n\nconst getIcon = (url: string) => {\n\tconst domain = new URL(url).hostname;\n\treturn domain ? `https://favicone.com/${domain}` : \"/favicon.ico\";\n};\n\nwindow.tabs = [];\n\nconst transportOptions: TransportOptions = {\n\tepoxy:\n\t\t\"https://unpkg.com/@mercuryworkshop/epoxy-transport@2.1.27/dist/index.mjs\",\n\tlibcurl:\n\t\t\"https://unpkg.com/@mercuryworkshop/libcurl-transport@1.5.0/dist/index.mjs\",\n};\n\n//////////////////////////////\n///           SW           ///\n//////////////////////////////\nconst stockSW = \"/ultraworker.js\";\nconst swAllowedHostnames = [\"localhost\", \"127.0.0.1\"];\n\nasync function registerSW(): Promise<void> {\n\tif (!navigator.serviceWorker) {\n\t\tif (\n\t\t\tlocation.protocol !== \"https:\" &&\n\t\t\t!swAllowedHostnames.includes(location.hostname)\n\t\t)\n\t\t\tthrow new Error(\"Service workers cannot be registered without https.\");\n\n\t\tthrow new Error(\"Your browser doesn't support service workers.\");\n\t}\n\n\tawait navigator.serviceWorker.register(stockSW);\n}\n\nrequestIdleCallback(async () => {\n\tconst { ScramjetController } = window.$scramjetLoadController();\n\tconst scramjet = new ScramjetController({\n\t\tfiles: {\n\t\t\twasm: \"https://cdn.jsdelivr.net/gh/Bromine-Labs/cdn@main/crasm/scramjet.wasm.wasm\",\n\t\t\tall: \"https://cdn.jsdelivr.net/gh/Bromine-Labs/cdn@main/crasm/scramjet.all.js\",\n\t\t\tsync: \"https://cdn.jsdelivr.net/gh/Bromine-Labs/cdn@main/crasm/scramjet.sync.js\",\n\t\t},\n\t\tflags: {\n\t\t\trewriterLogs: false,\n\t\t\tscramitize: false,\n\t\t\tcleanErrors: true,\n\t\t},\n\t\tsiteFlags: {\n\t\t\t\"https://worker-playground.glitch.me/.*\": {\n\t\t\t\tserviceworkers: true,\n\t\t\t},\n\t\t},\n\t});\n\tscramjet.init();\n\twindow.scramjet = scramjet;\n\tregisterSW()\n\t\t.then(() => console.log(\"lethal.js: Service Worker registered\"))\n\t\t.catch((err) =>\n\t\t\tconsole.error(\"lethal.js: Failed to register Service Worker\", err),\n\t\t);\n\tnew Tab();\n});\n\n//////////////////////////////\n///        Functions       ///\n//////////////////////////////\nexport function makeURL(\n\tinput: string,\n\ttemplate = \"https://duckduckgo.com/search?q=%s\",\n): string {\n\ttry {\n\t\treturn new URL(input).toString();\n\t} catch (err) { }\n\n\ttry {\n\t\tconst url = new URL(`http://${input}`);\n\t\tif (url.hostname.includes(\".\")) return url.toString();\n\t} catch (err) { }\n\n\treturn template.replace(\"%s\", encodeURIComponent(input));\n}\n\nasync function updateBareMux(): Promise<void> {\n\tif (transportURL != null && wispURL != null) {\n\t\tconsole.log(\n\t\t\t`lethal.js: Setting BareMux to ${transportURL} and Wisp to ${wispURL}`,\n\t\t);\n\n\t\tawait connection.setTransport(transportURL, [{ wisp: wispURL }]);\n\t}\n}\n\nexport async function setTransport(transport: Transport): Promise<void> {\n\tconsole.log(`lethal.js: Setting transport to ${transport}`);\n\ttransportURL = transportOptions[transport];\n\tif (!transportURL) {\n\t\ttransportURL = transport;\n\t}\n\n\tawait updateBareMux();\n}\n\nexport function getTransport(): string {\n\treturn transportURL;\n}\n\nexport async function setWisp(wisp: string): Promise<void> {\n\tconsole.log(`lethal.js: Setting Wisp to ${wisp}`);\n\twispURL = wisp;\n\n\tawait updateBareMux();\n}\n\nexport function getWisp(): string {\n\treturn wispURL;\n}\n\nexport async function getProxied(url: string): Promise<any> {\n\tif (url.startsWith(\"bromine://\")) {\n\t\treturn url.replace(\"bromine://\", \"/\");\n\t}\n\n\treturn scramjet.encodeUrl(url);\n}\n\nexport function setFrames(frames: HTMLElement): void {\n\tframesElement = frames;\n}\n\nexport class Tab {\n\tframe: any;\n\ttabNumber: number;\n\ttitle: string = \"New Tab\";\n\turl: string = \"bromine://newtab\";\n\ttimesErrored: number;\n\tuiElement: HTMLElement;\n\n\tconstructor() {\n\t\tif (!framesElement) return;\n\t\ttabCounter++;\n\t\tthis.tabNumber = tabCounter;\n\n\t\tthis.frame = scramjet.createFrame();\n\t\tthis.frame.frame.setAttribute(\"class\", \"w-full h-full border-0 absolute\");\n\t\tthis.frame.frame.setAttribute(\"title\", \"Proxy Frame\");\n\t\tthis.frame.frame.setAttribute(\"src\", \"/newtab\");\n\t\tthis.frame.frame.setAttribute(\"id\", `frame-${tabCounter}`);\n\t\tframesElement.appendChild(this.frame.frame);\n\n\t\tthis.createUI();\n\t\twindow.tabs.push(this);\n\t\tthis.switch();\n\n\t\tthis.frame.frame.addEventListener(\"load\", () => {\n\t\t\tconst url = scramjet.decodeUrl(\n\t\t\t\tthis.frame.frame.contentWindow.location.href,\n\t\t\t);\n\t\t\tthis.handleLoad(url);\n\t\t});\n\t}\n\n\tcreateUI() {\n\t\tconst tabsDiv = document.getElementById(\"tabs\");\n\t\tif (!tabsDiv) return;\n\n\t\tconst tabEl = document.createElement(\"div\");\n\t\ttabEl.className =\n\t\t\t\"flex items-center min-w-[8rem] max-w-xs px-4 py-1 bg-overlay light hover:bg-overlay cursor-pointer transition-all duration-150 draggable-tab\";\n\t\ttabEl.dataset.tabId = this.tabNumber;\n\t\ttabEl.draggable = true;\n\n\t\ttabEl.innerHTML = `\n\t      <img class=\"w-4 h-4 mr-2 rounded\" alt=\"Favicon\" src=\"/favicon.ico\" />\n\t      <span class=\"tab truncate flex-1 text-sm\">${this.title}</span>\n\t      <button class=\"ml-2 text-xl focus:outline-none\">&times;</button>\n\t    `;\n\n\t\ttabEl.querySelector(\"button\")?.addEventListener(\"click\", (e) => {\n\t\t\te.stopPropagation();\n\t\t\tthis.close();\n\t\t});\n\n\t\ttabEl.addEventListener(\"click\", () => this.switch());\n\n\t\ttabsDiv.appendChild(tabEl);\n\t\tthis.uiElement = tabEl;\n\t}\n\n\tupdateUI() {\n\t\tif (!this.uiElement) return;\n\t\tconst img = this.uiElement.querySelector(\"img\");\n\t\tconst span = this.uiElement.querySelector(\".tab\");\n\n\t\tif (img) img.src = this.url ? getIcon(this.url) : \"/favicon.ico\";\n\t\tif (span) span.textContent = this.title || \"New Tab\";\n\n\t\twindow.tabs.forEach((tab) => {\n\t\t\tif (!tab.uiElement) return;\n\t\t\tconst isActive = tab.tabNumber === currentTab;\n\t\t\ttab.uiElement.classList.toggle(\"border-x-3\", isActive);\n\t\t\ttab.uiElement.classList.toggle(\"bg-overlay\", isActive);\n\t\t\ttab.uiElement.classList.toggle(\"active\", isActive);\n\t\t\ttab.uiElement.classList.toggle(\"font-medium\", isActive);\n\t\t\ttab.uiElement.classList.toggle(\"border-border\", isActive);\n\t\t});\n\t}\n\n\tswitch(): void {\n\t\tcurrentTab = this.tabNumber;\n\t\tframesElement\n\t\t\t.querySelectorAll(\"iframe\")\n\t\t\t.forEach((frame) => frame.classList.add(\"hidden\"));\n\t\tthis.frame.frame.classList.remove(\"hidden\");\n\n\t\tcurrentFrame = this.frame.frame;\n\t\taddressInput.value = scramjet.decodeUrl(\n\t\t\tcurrentFrame?.contentWindow?.location.href ?? \"\",\n\t\t);\n\t\tthis.updateUI();\n\t}\n\n\tclose(): void {\n\t\tthis.frame.frame.remove();\n\t\tthis.uiElement?.remove();\n\t\twindow.tabs = window.tabs.filter((t) => t.tabNumber !== this.tabNumber);\n\n\t\tif (currentTab === this.tabNumber) {\n\t\t\tif (window.tabs.length > 0) window.tabs[0].switch();\n\t\t\telse newTab();\n\t\t}\n\t}\n\n\thandleLoad(url: string): void {\n\t\tif (this.tabNumber !== currentTab) return;\n\n\t\tthis.title = this.frame.frame?.contentWindow?.document.title || \"New Tab\";\n\t\tthis.url = url;\n\n\t\tconst doc =\n\t\t\tthis.frame.frame.contentDocument ||\n\t\t\tthis.frame.frame.contentWindow.document;\n\t\tconst text = doc.body?.textContent?.toLowerCase() || \"\";\n\n\t\tconst bareErr = text.includes(\"there are no bare clients\");\n\t\tconst otherErr = doc.querySelector(\"#errorTitle\");\n\n\t\tif (bareErr) {\n\t\t\tif (++this.timesErrored <= 5) {\n\t\t\t\tconsole.warn(`Bare client error (${this.timesErrored}/5) â†’ reloading`);\n\t\t\t\tthis.frame.frame.contentWindow.location.reload();\n\t\t\t}\n\t\t} else if (otherErr) {\n\t\t\tconsole.warn(`Iframe error (${++this.timesErrored})`);\n\t\t} else {\n\t\t\tthis.timesErrored = 0;\n\t\t}\n\t\t//\n\t\t// try {\n\t\t//   let history = JSON.parse(localStorage.getItem(\"history\"));\n\t\t//   history.push({ url, title: this.title });\n\t\t//   localStorage.setItem(\"history\", JSON.stringify(history));\n\t\t// } catch {}\n\n\t\tthis.updateUI();\n\t\taddressInput.value = url;\n\t}\n}\n\nexport async function newTab() {\n\tnew Tab();\n}\n\nexport function switchTab(tabNumber: number): void {\n\tconst tabToSwitchTo = window.tabs.find((tab) => tab.tabNumber === tabNumber);\n\tif (tabToSwitchTo) {\n\t\ttabToSwitchTo.switch();\n\t} else {\n\t\tconsole.warn(\n\t\t\t`lethal.js: Attempted to switch to non-existent tab #${tabNumber}`,\n\t\t);\n\t}\n}\n\nexport function closeTab(tabNumber: number): void {\n\tconst tabToClose = window.tabs.find((tab) => tab.tabNumber === tabNumber);\n\n\tif (tabToClose) {\n\t\ttabToClose.close();\n\n\t\tif (currentTab === tabNumber) {\n\t\t\tif (window.tabs.length > 0) {\n\t\t\t\twindow.tabs[0].switch();\n\t\t\t} else {\n\t\t\t\tnewTab();\n\t\t\t}\n\t\t}\n\t} else {\n\t\tconsole.warn(\n\t\t\t`lethal.js: Attempted to close non-existent tab #${tabNumber}`,\n\t\t);\n\t}\n}\n"],"names":["connection","BareMuxConnection","wispURL","transportURL","tabCounter","currentTab","framesElement","currentFrame","addressInput","getIcon","url","domain","transportOptions","stockSW","swAllowedHostnames","registerSW","ScramjetController","scramjet","err","Tab","makeURL","input","template","updateBareMux","setTransport","transport","setWisp","wisp","getProxied","setFrames","frames","tabsDiv","tabEl","e","img","span","tab","isActive","frame","t","newTab","doc","bareErr","otherErr"],"mappings":"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"}